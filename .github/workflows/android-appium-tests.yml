name: Android Appium Tests

on:
  schedule:
    - cron: '0 2 * * *'  # 2:00 UTC = 9:00 GMT+7
  workflow_dispatch:      # Cho phép chạy thủ công

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
    
    - name: Install Appium and Dependencies
      run: |
        npm install -g appium
        appium driver install uiautomator2
        
    - name: Set up Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Create and start emulator
      run: |
        sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        sdkmanager "system-images;android-33;google_apis;x86_64"
        echo "no" | avdmanager create avd -n test_device -k "system-images;android-33;google_apis;x86_64"
        $ANDROID_HOME/emulator/emulator -avd test_device -no-audio -no-window &
        adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
        
    - name: Start Appium Server
      run: |
        appium --log appium.log &
        sleep 10
        
    - name: Install App
      run: |
        adb install app/vpa.apk
        
    - name: Run Tests
      run: mvn clean test
      
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v2
      with:
        name: test-results
        path: |
          test-output/
          appium.log
